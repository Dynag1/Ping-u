<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring R√©seau - Ping √º</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f3f4f6;
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-card .label {
            color: #6b7280;
            font-size: 14px;
        }

        .stat-card .value {
            color: #111827;
            font-size: 20px;
            font-weight: bold;
        }

        .stat-card.total .value { color: #3b82f6; }
        .stat-card.online .value { color: #10b981; }
        .stat-card.offline .value { color: #ef4444; }
        .stat-card.high-temp .value { color: #f59e0b; }

        .hosts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .host-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid #10b981;
        }

        .host-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .host-card.offline {
            border-left-color: #ef4444;
            opacity: 0.85;
        }

        .host-card.high-temp {
            border-left-color: #f59e0b;
            background: rgba(255, 251, 235, 0.98);
        }

        .host-card.high-temp .detail-value.temp-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .host-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .host-name {
            font-size: 18px;
            font-weight: bold;
            color: #111827;
            word-break: break-word;
            flex: 1;
        }

        .host-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .host-status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .host-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .host-ip {
            font-size: 20px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .host-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .detail-value {
            color: #111827;
            font-size: 13px;
            font-weight: 500;
            word-break: break-all;
        }

        .no-hosts {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .no-hosts h2 {
            color: #6b7280;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .no-hosts p {
            color: #9ca3af;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .last-update {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 20px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .hosts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .host-metrics {
                grid-template-columns: 1fr;
            }
        }

        .icon {
            font-size: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üåê Monitoring R√©seau - Ping √º
                <span class="status-badge">
                    <span class="status-dot"></span>
                    <span>Connect√©</span>
                </span>
            </h1>
            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                <label style="color: #6b7280; font-weight: 600;">Trier par :</label>
                <select id="sort-select" onchange="changeSort()" style="padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <option value="status-offline-first">Statut (HS en premier)</option>
                    <option value="status-online-first">Statut (En ligne en premier)</option>
                    <option value="ip-asc">Adresse IP (Croissant)</option>
                    <option value="ip-desc">Adresse IP (D√©croissant)</option>
                    <option value="name-asc">Nom (A-Z)</option>
                    <option value="name-desc">Nom (Z-A)</option>
                </select>
            </div>
            <div class="stats">
                <div class="stat-card total">
                    <span class="label">Total:</span>
                    <span class="value" id="total-hosts">0</span>
                </div>
                <div class="stat-card online">
                    <span class="icon">üü¢</span>
                    <span class="label">En ligne:</span>
                    <span class="value" id="online-hosts">0</span>
                </div>
                <div class="stat-card offline">
                    <span class="icon">üî¥</span>
                    <span class="label">Hors ligne:</span>
                    <span class="value" id="offline-hosts">0</span>
                </div>
                <div class="stat-card high-temp">
                    <span class="icon">üå°Ô∏è</span>
                    <span class="label">Temp. √©lev√©e:</span>
                    <span class="value" id="high-temp-hosts">0</span>
                </div>
            </div>
        </div>

        <div id="hosts-container">
            <div class="loading">Chargement des h√¥tes</div>
        </div>

        <div class="last-update">
            Derni√®re mise √† jour: <span id="last-update-time">-</span>
        </div>
    </div>

    <script>
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 10
        });
        
        let hostsData = [];
        let currentSort = 'status-offline-first';
        let tempSeuil = 70; // Seuil de temp√©rature par d√©faut (sera mis √† jour depuis les settings)
        
        // Charger le seuil de temp√©rature depuis les settings
        async function loadTempSeuil() {
            try {
                const response = await fetch('/api/get_settings');
                const result = await response.json();
                if (result.alerts && result.alerts.temp_seuil) {
                    tempSeuil = result.alerts.temp_seuil;
                }
            } catch (e) {
                console.log('Utilisation du seuil par d√©faut:', tempSeuil);
            }
        }
        loadTempSeuil();
        
        // Fonction pour v√©rifier si la temp√©rature est √©lev√©e
        function isHighTemp(tempValue) {
            if (!tempValue || tempValue === '-') return false;
            const temp = parseFloat(tempValue.replace('¬∞C', '').replace('¬∞', '').trim());
            return !isNaN(temp) && temp >= tempSeuil;
        }
        
        socket.on('connect', function() {
            updateStatusBadge(true);
            socket.emit('request_update');
        });

        socket.on('disconnect', function() {
            updateStatusBadge(false);
        });

        socket.on('hosts_update', function(hosts) {
            if (!Array.isArray(hosts)) {
                hosts = [];
            }
            
            hostsData = hosts;
            renderHosts(hosts);
            updateStats(hosts);
            updateLastUpdateTime();
        });

        function changeSort() {
            currentSort = document.getElementById('sort-select').value;
            renderHosts(hostsData);
        }

        function naturalSort(a, b) {
            // Fonction pour le tri naturel (g√®re les nombres dans les cha√Ænes)
            const ax = [], bx = [];
            
            String(a).replace(/(\d+)|(\D+)/g, function(_, $1, $2) { ax.push([$1 || Infinity, $2 || ""]) });
            String(b).replace(/(\d+)|(\D+)/g, function(_, $1, $2) { bx.push([$1 || Infinity, $2 || ""]) });
            
            while(ax.length && bx.length) {
                const an = ax.shift();
                const bn = bx.shift();
                const nn = (an[0] - bn[0]) || an[1].localeCompare(bn[1]);
                if(nn) return nn;
            }
            
            return ax.length - bx.length;
        }

        function sortHostsData(hosts) {
            return [...hosts].sort((a, b) => {
                switch(currentSort) {
                    case 'status-offline-first':
                        if (a.status === 'offline' && b.status === 'online') return -1;
                        if (a.status === 'online' && b.status === 'offline') return 1;
                        // Si m√™me statut, trier par IP
                        return compareIPs(a.ip, b.ip);
                    
                    case 'status-online-first':
                        if (a.status === 'online' && b.status === 'offline') return -1;
                        if (a.status === 'offline' && b.status === 'online') return 1;
                        // Si m√™me statut, trier par IP
                        return compareIPs(a.ip, b.ip);
                    
                    case 'ip-asc':
                        return compareIPs(a.ip, b.ip);
                    
                    case 'ip-desc':
                        return compareIPs(b.ip, a.ip);
                    
                    case 'name-asc':
                        return naturalSort(a.nom || a.ip, b.nom || b.ip);
                    
                    case 'name-desc':
                        return naturalSort(b.nom || b.ip, a.nom || a.ip);
                    
                    default:
                        return 0;
                }
            });
        }

        function compareIPs(ipA, ipB) {
            const partsA = ipA.split('.').map(Number);
            const partsB = ipB.split('.').map(Number);
            
            for (let i = 0; i < 4; i++) {
                if (partsA[i] !== partsB[i]) {
                    return partsA[i] - partsB[i];
                }
            }
            return 0;
        }
        
        socket.on('connect_error', function(error) {
            updateStatusBadge(false);
            document.getElementById('hosts-container').innerHTML = `
                <div class="no-hosts">
                    <h2>Erreur de connexion</h2>
                    <p>Impossible de se connecter au serveur. V√©rifiez que le serveur web est d√©marr√©.</p>
                </div>
            `;
        });

        function updateStatusBadge(connected) {
            const badge = document.querySelector('.status-badge');
            const badgeText = badge.querySelector('span:last-child');
            
            if (connected) {
                badge.style.background = '#10b981';
                badgeText.textContent = 'Connect√©';
            } else {
                badge.style.background = '#ef4444';
                badgeText.textContent = 'D√©connect√©';
            }
        }

        function renderHosts(hosts) {
            const container = document.getElementById('hosts-container');
            
            if (!hosts || hosts.length === 0) {
                container.innerHTML = `
                    <div class="no-hosts">
                        <h2>Aucun h√¥te trouv√©</h2>
                        <p>Ajoutez des h√¥tes dans l'application pour les voir appara√Ætre ici.</p>
                    </div>
                `;
                return;
            }

            // Trier les h√¥tes selon le choix actuel
            const sortedHosts = sortHostsData(hosts);

            // R√©cup√©rer ou cr√©er le conteneur grid
            let grid = container.querySelector('.hosts-grid');
            if (!grid) {
                grid = document.createElement('div');
                grid.className = 'hosts-grid';
                container.innerHTML = '';
                container.appendChild(grid);
            }

            // Mettre √† jour ou cr√©er chaque carte
            sortedHosts.forEach((host, index) => {
                const cardId = `host-card-${host.ip.replace(/\./g, '-')}`;
                let card = document.getElementById(cardId);
                
                if (!card) {
                    // Cr√©er une nouvelle carte
                    card = createHostCardElement(host, cardId);
                    grid.appendChild(card);
                } else {
                    // Mettre √† jour la carte existante sans recr√©er
                    updateHostCard(card, host);
                }
                
                // R√©ordonner visuellement en changeant l'ordre dans le DOM si n√©cessaire
                if (grid.children[index] !== card) {
                    grid.insertBefore(card, grid.children[index]);
                }
            });

            // Supprimer les cartes des h√¥tes qui n'existent plus
            const currentCards = grid.querySelectorAll('[id^="host-card-"]');
            const currentIPs = sortedHosts.map(h => h.ip.replace(/\./g, '-'));
            currentCards.forEach(card => {
                const cardIP = card.id.replace('host-card-', '');
                if (!currentIPs.includes(cardIP)) {
                    card.remove();
                }
            });
        }

        function createHostCardElement(host, cardId) {
            const card = document.createElement('div');
            card.id = cardId;
            
            const temperature = host.temp || '-';
            const highTemp = isHighTemp(temperature);
            
            // Classe de la carte: offline prioritaire, puis high-temp, puis online
            let cardClass = `host-card ${host.status}`;
            if (highTemp && host.status === 'online') {
                cardClass += ' high-temp';
            }
            card.className = cardClass;
            
            const displayName = host.nom || 'Sans nom';
            const statusText = host.status === 'online' ? 'En ligne' : 'Hors ligne';
            const debitIn = host.debit_in || 'N/A';
            const debitOut = host.debit_out || 'N/A';
            const tempClass = highTemp ? 'detail-value temp-warning' : 'detail-value';
            
            card.innerHTML = `
                <div class="host-header">
                    <div class="host-name">${escapeHtml(displayName)}</div>
                    <div class="host-status ${host.status}">${statusText}</div>
                </div>
                <div class="host-ip">${escapeHtml(host.ip)}</div>
                <div class="host-details">
                    <div class="detail-item">
                        <div class="detail-label">MAC</div>
                        <div class="detail-value">${escapeHtml(host.mac) || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">üå°Ô∏è Temp√©rature</div>
                        <div class="${tempClass}">${escapeHtml(temperature)}${highTemp ? ' ‚ö†Ô∏è' : ''}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">üì• D√©bit IN</div>
                        <div class="detail-value">${escapeHtml(debitIn)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">üì§ D√©bit OUT</div>
                        <div class="detail-value">${escapeHtml(debitOut)}</div>
                    </div>
                </div>
            `;
            
            return card;
        }

        function updateHostCard(card, host) {
            const displayName = host.nom || 'Sans nom';
            const statusText = host.status === 'online' ? 'En ligne' : 'Hors ligne';
            const temperature = host.temp || '-';
            const highTemp = isHighTemp(temperature);
            const debitIn = host.debit_in || 'N/A';
            const debitOut = host.debit_out || 'N/A';
            
            // Mettre √† jour la classe de statut (avec high-temp si applicable)
            let cardClass = `host-card ${host.status}`;
            if (highTemp && host.status === 'online') {
                cardClass += ' high-temp';
            }
            card.className = cardClass;
            
            // Mettre √† jour le nom
            const nameEl = card.querySelector('.host-name');
            if (nameEl && nameEl.textContent !== displayName) {
                nameEl.textContent = displayName;
            }
            
            // Mettre √† jour le statut
            const statusEl = card.querySelector('.host-status');
            if (statusEl) {
                statusEl.className = `host-status ${host.status}`;
                if (statusEl.textContent !== statusText) {
                    statusEl.textContent = statusText;
                }
            }
            
            // Mettre √† jour les valeurs d√©taill√©es
            const details = card.querySelectorAll('.detail-value');
            if (details.length >= 4) {
                // MAC (index 0)
                if (details[0].textContent !== (host.mac || '-')) {
                    details[0].textContent = host.mac || '-';
                }
                // Temp√©rature (index 1) - avec indicateur d'alerte
                const tempDisplay = temperature + (highTemp ? ' ‚ö†Ô∏è' : '');
                details[1].className = highTemp ? 'detail-value temp-warning' : 'detail-value';
                if (details[1].textContent !== tempDisplay) {
                    details[1].textContent = tempDisplay;
                }
                // D√©bit IN (index 2)
                if (details[2].textContent !== debitIn) {
                    details[2].textContent = debitIn;
                }
                // D√©bit OUT (index 3)
                if (details[3].textContent !== debitOut) {
                    details[3].textContent = debitOut;
                }
            }
        }

        function updateStats(hosts) {
            const total = hosts.length;
            const online = hosts.filter(h => h.status === 'online').length;
            const offline = total - online;
            const highTempCount = hosts.filter(h => h.status === 'online' && isHighTemp(h.temp)).length;

            document.getElementById('total-hosts').textContent = total;
            document.getElementById('online-hosts').textContent = online;
            document.getElementById('offline-hosts').textContent = offline;
            document.getElementById('high-temp-hosts').textContent = highTempCount;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR');
            document.getElementById('last-update-time').textContent = timeString;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Demander une mise √† jour toutes les 10 secondes
        setInterval(() => {
            socket.emit('request_update');
        }, 10000);

        // Demander les donn√©es imm√©diatement au chargement
        socket.emit('request_update');
    </script>
</body>
</html>

