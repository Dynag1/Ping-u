<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring R√©seau - Ping √º</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .badges-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #10b981;
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .status-badge.disconnected {
            background: #ef4444;
            animation: none;
        }

        .scan-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: #6b7280;
            color: white;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
        }

        .scan-badge.running {
            background: #3b82f6;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        .status-badge.disconnected .status-dot {
            animation: none;
        }

        .scan-badge .status-dot {
            animation: none;
        }

        .scan-badge.running .status-dot {
            animation: blink 1.5s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* Language selector */
        .lang-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            padding: 6px 12px;
            border-radius: 20px;
        }

        .lang-selector label {
            color: #6b7280;
            font-size: 12px;
            font-weight: 600;
        }

        .lang-selector select {
            background: transparent;
            border: none;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            padding: 2px 4px;
        }

        .lang-selector select:focus {
            outline: none;
        }

        /* User controls */
        .user-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 8px 15px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .user-icon {
            font-size: 18px;
        }

        .user-name {
            color: #1f2937;
        }

        .admin-link {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .admin-link:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .logout-btn {
            background: #fee2e2;
            border: none;
            padding: 6px 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .logout-btn:hover {
            background: #fecaca;
            transform: scale(1.1);
        }

        .controls-row {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stats {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: #f3f4f6;
            padding: 12px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-card .label {
            color: #6b7280;
            font-size: 14px;
        }

        .stat-card .value {
            color: #111827;
            font-size: 20px;
            font-weight: bold;
        }

        .stat-card.total .value {
            color: #3b82f6;
        }

        .stat-card.online .value {
            color: #10b981;
        }

        .stat-card.offline .value {
            color: #ef4444;
        }

        .stat-card.high-temp .value {
            color: #ef4444;
        }

        .stat-card.warning-temp .value {
            color: #f59e0b;
        }

        .hosts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .host-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-left: 5px solid #10b981;
        }

        .host-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .host-card.offline {
            border-left-color: #ef4444;
            opacity: 0.85;
        }

        .host-card.warning-temp {
            border-left-color: #f59e0b;
            background: rgba(255, 251, 235, 0.98);
        }

        .host-card.high-temp {
            border-left-color: #ef4444;
            background: rgba(254, 242, 242, 0.98);
        }

        .detail-value.temp-warning {
            color: #f59e0b;
            font-weight: bold;
        }

        .detail-value.temp-critical {
            color: #ef4444;
            font-weight: bold;
        }

        .host-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .host-name {
            font-size: 18px;
            font-weight: bold;
            color: #111827;
            word-break: break-word;
            flex: 1;
        }

        .host-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .host-status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .host-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Couleurs de latence pour le badge "En ligne" */
        .host-status.latency-green {
            background: #baf595;
            color: #1a5d1a;
        }

        .host-status.latency-yellow {
            background: #fffd6a;
            color: #7a6800;
        }

        .host-status.latency-orange {
            background: #ffb845;
            color: #7a4000;
        }

        .host-ip {
            font-size: 20px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
            font-family: 'Courier New', monospace;
        }

        .host-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            color: #6b7280;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .detail-value {
            color: #111827;
            font-size: 13px;
            font-weight: 500;
            word-break: break-all;
        }

        .no-hosts {
            text-align: center;
            padding: 60px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .no-hosts h2 {
            color: #6b7280;
            font-size: 24px;
            margin-bottom: 10px;
        }

        .no-hosts p {
            color: #9ca3af;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .last-update {
            text-align: center;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 20px;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .hosts-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-top {
                flex-direction: column;
                gap: 15px;
            }

            .host-metrics {
                grid-template-columns: 1fr;
            }
        }

        .icon {
            font-size: 20px;
        }

        .comment-item {
            grid-column: span 2;
            margin-top: 8px;
            border-top: 1px solid #e5e7eb;
            padding-top: 8px;
        }

        .comment-input {
            width: 100%;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 8px;
            font-size: 13px;
            resize: vertical;
            min-height: 50px;
            font-family: inherit;
            transition: all 0.2s;
            background: #ffffff;
            color: #374151;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .comment-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1), inset 0 1px 2px rgba(0, 0, 0, 0.05);
            background: #fff;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>
                    üåê <span data-i18n="title">Monitoring R√©seau - Ping √º</span>
                </h1>
                <div class="user-controls">
                    <!-- Info utilisateur et boutons -->
                    <div class="user-info-badge" id="user-info-badge">
                        <span class="user-icon">üë§</span>
                        <span class="user-name" id="current-username">{{ username or '' }}</span>
                        {% if is_admin %}
                        <a href="/admin" class="admin-link" title="Administration">
                            ‚öôÔ∏è <span data-i18n="admin">Admin</span>
                        </a>
                        {% endif %}
                        <button class="logout-btn" onclick="logout()" title="D√©connexion">
                            üö™
                        </button>
                    </div>
                    <div class="lang-selector">
                        <label>üåç</label>
                        <select id="lang-select" onchange="changeLanguage(this.value)">
                            <option value="fr">Fran√ßais</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="badges-container" style="margin-bottom: 15px;">
                <span class="status-badge" id="connection-badge">
                    <span class="status-dot"></span>
                    <span data-i18n="connected">Connect√©</span>
                </span>
                <span class="scan-badge" id="scan-badge">
                    <span class="status-dot"></span>
                    <span data-i18n="scan_stopped">Scan arr√™t√©</span>
                </span>
            </div>
            <div class="controls-row">
                <label style="color: #6b7280; font-weight: 600;" data-i18n="sort_by">Trier par :</label>
                <select id="sort-select" onchange="changeSort()"
                    style="padding: 8px; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <option value="status-offline-first" data-i18n="sort_offline_first">Statut (HS en premier)</option>
                    <option value="status-online-first" data-i18n="sort_online_first">Statut (En ligne en premier)
                    </option>
                    <option value="ip-asc" data-i18n="sort_ip_asc">Adresse IP (Croissant)</option>
                    <option value="ip-desc" data-i18n="sort_ip_desc">Adresse IP (D√©croissant)</option>
                    <option value="name-asc" data-i18n="sort_name_asc">Nom (A-Z)</option>
                    <option value="name-desc" data-i18n="sort_name_desc">Nom (Z-A)</option>
                </select>

                <!-- Filtre par site - Design Premium -->
                <div class="site-filter-premium">
                    <div class="site-filter-icon">üè¢</div>
                    <div class="site-filter-content">
                        <span class="site-filter-label" data-i18n="filter_site">Filtrer par site</span>
                        <select id="site-filter-select" multiple onchange="applySiteFilterLocal()"
                            class="site-filter-select">
                        </select>
                    </div>
                    <button onclick="clearSiteFilterLocal()" class="site-filter-reset-btn"
                        title="Afficher tous les sites">
                        <span data-i18n="all_sites">Tous</span>
                    </button>
                </div>

                <style>
                    .site-filter-premium {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
                        padding: 10px 18px;
                        border-radius: 30px;
                        margin-left: 15px;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
                        border: 1px solid rgba(102, 126, 234, 0.15);
                        transition: all 0.3s ease;
                    }

                    .site-filter-premium:hover {
                        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
                        border-color: rgba(102, 126, 234, 0.3);
                    }

                    .site-filter-icon {
                        width: 36px;
                        height: 36px;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 18px;
                        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.25);
                        flex-shrink: 0;
                    }

                    .site-filter-content {
                        display: flex;
                        flex-direction: column;
                        gap: 4px;
                    }

                    .site-filter-label {
                        font-size: 11px;
                        color: #9ca3af;
                        font-weight: 600;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }

                    .site-filter-select {
                        min-width: 140px;
                        max-width: 200px;
                        padding: 6px 10px;
                        border-radius: 8px;
                        border: 1px solid #e5e7eb;
                        font-size: 13px;
                        font-weight: 500;
                        background: white;
                        cursor: pointer;
                        transition: all 0.2s ease;
                    }

                    .site-filter-select:focus {
                        outline: none;
                        border-color: #667eea;
                        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
                    }

                    .site-filter-select option:checked {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                    }

                    .site-filter-reset-btn {
                        padding: 8px 16px;
                        border-radius: 20px;
                        border: none;
                        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
                        color: white;
                        font-size: 12px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        white-space: nowrap;
                    }

                    .site-filter-reset-btn:hover {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        transform: scale(1.05);
                        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    }

                    @media (max-width: 768px) {
                        .site-filter-premium {
                            margin-left: 0;
                            margin-top: 10px;
                            width: 100%;
                        }

                        .site-filter-select {
                            flex: 1;
                        }
                    }
                </style>
            </div>
            <div class="stats">
                <div class="stat-card total">
                    <span class="label" data-i18n="total">Total:</span>
                    <span class="value" id="total-hosts">0</span>
                </div>
                <div class="stat-card online">
                    <span class="icon">üü¢</span>
                    <span class="label" data-i18n="online">En ligne:</span>
                    <span class="value" id="online-hosts">0</span>
                </div>
                <div class="stat-card offline">
                    <span class="icon">üî¥</span>
                    <span class="label" data-i18n="offline">Hors ligne:</span>
                    <span class="value" id="offline-hosts">0</span>
                </div>
                <div class="stat-card warning-temp">
                    <span class="icon">üå°Ô∏è</span>
                    <span class="label" data-i18n="warning_temp">Warning Temp:</span>
                    <span class="value" id="warning-temp-hosts">0</span>
                </div>
                <div class="stat-card high-temp">
                    <span class="icon">üî•</span>
                    <span class="label" data-i18n="high_temp">Temp. Critique:</span>
                    <span class="value" id="high-temp-hosts">0</span>
                </div>
            </div>
        </div>

        <div id="hosts-container">
            <div class="loading" data-i18n="loading">Chargement des h√¥tes</div>
        </div>

        <div class="last-update">
            <span data-i18n="last_update">Derni√®re mise √† jour:</span> <span id="last-update-time">-</span>
        </div>
    </div>

    <script>
        // ==================== Syst√®me de traduction ====================
        const translations = {
            fr: {
                title: "Monitoring R√©seau - Ping √º",
                connected: "Connect√©",
                disconnected: "D√©connect√©",
                scan_running: "Scan en cours",
                scan_stopped: "Scan arr√™t√©",
                sort_by: "Trier par :",
                sort_offline_first: "Statut (HS en premier)",
                sort_online_first: "Statut (En ligne en premier)",
                sort_ip_asc: "Adresse IP (Croissant)",
                sort_ip_desc: "Adresse IP (D√©croissant)",
                sort_name_asc: "Nom (A-Z)",
                sort_name_desc: "Nom (Z-A)",
                total: "Total:",
                online: "En ligne:",
                offline: "Hors ligne:",
                high_temp: "Temp. Critique",
                warning_temp: "Temp. Warning",
                loading: "Chargement des h√¥tes",
                last_update: "Derni√®re mise √† jour:",
                no_hosts_title: "Aucun h√¥te trouv√©",
                no_hosts_message: "Ajoutez des h√¥tes dans l'application pour les voir appara√Ætre ici.",
                no_hosts_for_site: "Aucun h√¥te pour ce(s) site(s)",
                filter_site: "Site",
                all_sites: "Tous",
                connection_error_title: "Erreur de connexion",
                connection_error_message: "Impossible de se connecter au serveur. V√©rifiez que le serveur web est d√©marr√©.",
                admin: "Admin",
                logout: "D√©connexion",
                status_online: "En ligne",
                status_offline: "Hors ligne",
                no_name: "Sans nom",
                mac: "MAC",
                temperature: "Temp√©rature",
                bandwidth_in: "D√©bit IN",
                bandwidth_out: "D√©bit OUT",
                comment: "Commentaire"
            },
            en: {
                title: "Network Monitoring - Ping √º",
                connected: "Connected",
                disconnected: "Disconnected",
                scan_running: "Scan running",
                scan_stopped: "Scan stopped",
                sort_by: "Sort by:",
                sort_offline_first: "Status (Offline first)",
                sort_online_first: "Status (Online first)",
                sort_ip_asc: "IP Address (Ascending)",
                sort_ip_desc: "IP Address (Descending)",
                sort_name_asc: "Name (A-Z)",
                sort_name_desc: "Name (Z-A)",
                total: "Total:",
                online: "Online:",
                offline: "Offline:",
                high_temp: "Critical Temp",
                warning_temp: "Warning Temp",
                loading: "Loading hosts",
                last_update: "Last update:",
                no_hosts_title: "No hosts found",
                no_hosts_message: "Add hosts in the application to see them appear here.",
                no_hosts_for_site: "No hosts for this site(s)",
                filter_site: "Site",
                all_sites: "All",
                connection_error_title: "Connection error",
                connection_error_message: "Unable to connect to the server. Check that the web server is running.",
                admin: "Admin",
                logout: "Logout",
                status_online: "Online",
                status_offline: "Offline",
                no_name: "No name",
                mac: "MAC",
                temperature: "Temperature",
                bandwidth_in: "Bandwidth IN",
                bandwidth_out: "Bandwidth OUT",
                comment: "Comment"
            }
        };

        let currentLang = 'fr';

        // D√©tecter la langue du navigateur
        function detectBrowserLanguage() {
            const browserLang = navigator.language || navigator.userLanguage;
            // Si la langue commence par 'fr', utiliser fran√ßais, sinon anglais
            return browserLang.startsWith('fr') ? 'fr' : 'en';
        }

        // Charger la langue sauvegard√©e ou d√©tecter automatiquement
        function loadLanguage() {
            const savedLang = localStorage.getItem('ping√º_lang');
            if (savedLang && translations[savedLang]) {
                currentLang = savedLang;
            } else {
                currentLang = detectBrowserLanguage();
            }
            document.getElementById('lang-select').value = currentLang;
            applyTranslations();
        }

        // Changer la langue
        function changeLanguage(lang) {
            if (translations[lang]) {
                currentLang = lang;
                localStorage.setItem('ping√º_lang', lang);
                applyTranslations();
                // Re-render les h√¥tes pour mettre √† jour les textes
                if (hostsData.length > 0) {
                    renderHosts(hostsData);
                }
            }
        }

        // Appliquer les traductions
        function applyTranslations() {
            const t = translations[currentLang];

            // Mettre √† jour les √©l√©ments avec data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Mettre √† jour les options du select
            const sortSelect = document.getElementById('sort-select');
            Array.from(sortSelect.options).forEach(option => {
                const key = option.getAttribute('data-i18n');
                if (key && t[key]) {
                    option.textContent = t[key];
                }
            });

            // Mettre √† jour le titre de la page
            document.title = t.title;

            // Mettre √† jour l'attribut lang du HTML
            document.documentElement.lang = currentLang;
        }

        // Fonction d'aide pour obtenir une traduction
        function t(key) {
            return translations[currentLang][key] || key;
        }

        // ==================== Socket.IO ====================
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 10
        });

        let hostsData = [];
        let currentSort = 'status-offline-first';
        let tempSeuil = 70; // Seuil critique
        let tempSeuilWarning = 60; // Seuil de warning
        let scanRunning = false;
        let sitesList = [];
        let selectedSitesFilter = []; // Filtre local pour la page monitoring

        // Charger la liste des sites
        async function loadSitesList() {
            try {
                const response = await fetch('/api/get_sites');
                const data = await response.json();

                if (data.success) {
                    sitesList = data.sites || [];
                    updateSiteFilterSelect();
                }
            } catch (error) {
                console.error('Erreur chargement sites:', error);
            }
        }

        function updateSiteFilterSelect() {
            const select = document.getElementById('site-filter-select');
            if (!select) return;

            select.innerHTML = sitesList.map(site =>
                `<option value="${escapeHtml(site)}" ${selectedSitesFilter.includes(site) ? 'selected' : ''}>${escapeHtml(site)}</option>`
            ).join('');
        }

        function applySiteFilterLocal() {
            const select = document.getElementById('site-filter-select');
            selectedSitesFilter = Array.from(select.selectedOptions).map(opt => opt.value);
            renderHosts(hostsData);
        }

        function clearSiteFilterLocal() {
            selectedSitesFilter = [];
            const select = document.getElementById('site-filter-select');
            if (select) {
                Array.from(select.options).forEach(opt => opt.selected = false);
            }
            renderHosts(hostsData);
        }

        function filterHostsBySite(hosts) {
            if (selectedSitesFilter.length === 0) {
                return hosts; // Pas de filtre = tous les h√¥tes
            }
            return hosts.filter(host => selectedSitesFilter.includes(host.site || ''));
        }

        // Charger le seuil de temp√©rature depuis les settings
        async function loadTempSeuil() {
            try {
                const response = await fetch('/api/get_settings');
                const result = await response.json();
                if (result.alerts) {
                    if (result.alerts.temp_seuil) {
                        tempSeuil = result.alerts.temp_seuil;
                    }
                    if (result.alerts.temp_seuil_warning) {
                        tempSeuilWarning = result.alerts.temp_seuil_warning;
                    }
                }
                // Mettre √† jour le statut du scan
                if (typeof result.monitoring_running !== 'undefined') {
                    updateScanBadge(result.monitoring_running);
                }
            } catch (e) {
                console.log('Utilisation du seuil par d√©faut:', tempSeuil);
            }
        }
        loadTempSeuil();

        // Fonction pour v√©rifier si la temp√©rature est √©lev√©e
        function getTempAlertLevel(tempValue) {
            if (!tempValue || tempValue === '-') return 'none';
            const temp = parseFloat(tempValue.replace('¬∞C', '').replace('¬∞', '').trim());
            if (isNaN(temp)) return 'none';
            if (temp >= tempSeuil) return 'critical';
            if (temp >= tempSeuilWarning) return 'warning';
            return 'none';
        }

        // Fonction pour obtenir la classe CSS selon la couleur de latence
        function getLatencyClass(latencyColor) {
            if (!latencyColor) return '';
            switch (latencyColor.toLowerCase()) {
                case '#baf595': return 'latency-green';   // Vert clair < 100ms
                case '#fffd6a': return 'latency-yellow';  // Jaune 100-200ms
                case '#ffb845': return 'latency-orange';  // Orange > 200ms
                case '#f97e7e': return '';                // Rouge = offline (classe d√©j√† g√©r√©e)
                default: return '';
            }
        }

        socket.on('connect', function () {
            updateStatusBadge(true);
            socket.emit('request_update');
            loadSitesList(); // Charger la liste des sites
        });

        socket.on('disconnect', function () {
            updateStatusBadge(false);
        });

        socket.on('hosts_update', function (hosts) {
            if (!Array.isArray(hosts)) {
                hosts = [];
            }

            hostsData = hosts;
            renderHosts(hosts);
            updateStats(hosts);
            updateLastUpdateTime();
        });

        socket.on('monitoring_status', function (data) {
            updateScanBadge(data.running);
        });

        function changeSort() {
            currentSort = document.getElementById('sort-select').value;
            renderHosts(hostsData);
        }

        function naturalSort(a, b) {
            // Fonction pour le tri naturel (g√®re les nombres dans les cha√Ænes)
            const ax = [], bx = [];

            String(a).replace(/(\d+)|(\D+)/g, function (_, $1, $2) { ax.push([$1 || Infinity, $2 || ""]) });
            String(b).replace(/(\d+)|(\D+)/g, function (_, $1, $2) { bx.push([$1 || Infinity, $2 || ""]) });

            while (ax.length && bx.length) {
                const an = ax.shift();
                const bn = bx.shift();
                const nn = (an[0] - bn[0]) || an[1].localeCompare(bn[1]);
                if (nn) return nn;
            }

            return ax.length - bx.length;
        }

        function sortHostsData(hosts) {
            return [...hosts].sort((a, b) => {
                switch (currentSort) {
                    case 'status-offline-first':
                        if (a.status === 'offline' && b.status === 'online') return -1;
                        if (a.status === 'online' && b.status === 'offline') return 1;
                        // Si m√™me statut, trier par IP
                        return compareIPs(a.ip, b.ip);

                    case 'status-online-first':
                        if (a.status === 'online' && b.status === 'offline') return -1;
                        if (a.status === 'offline' && b.status === 'online') return 1;
                        // Si m√™me statut, trier par IP
                        return compareIPs(a.ip, b.ip);

                    case 'ip-asc':
                        return compareIPs(a.ip, b.ip);

                    case 'ip-desc':
                        return compareIPs(b.ip, a.ip);

                    case 'name-asc':
                        return naturalSort(a.nom || a.ip, b.nom || b.ip);

                    case 'name-desc':
                        return naturalSort(b.nom || b.ip, a.nom || a.ip);

                    default:
                        return 0;
                }
            });
        }

        function compareIPs(ipA, ipB) {
            const partsA = ipA.split('.').map(Number);
            const partsB = ipB.split('.').map(Number);

            for (let i = 0; i < 4; i++) {
                if (partsA[i] !== partsB[i]) {
                    return partsA[i] - partsB[i];
                }
            }
            return 0;
        }

        socket.on('connect_error', function (error) {
            updateStatusBadge(false);
            document.getElementById('hosts-container').innerHTML = `
                <div class="no-hosts">
                    <h2>${t('connection_error_title')}</h2>
                    <p>${t('connection_error_message')}</p>
                </div>
            `;
        });

        function updateStatusBadge(connected) {
            const badge = document.getElementById('connection-badge');
            const badgeText = badge.querySelector('span[data-i18n]');

            if (connected) {
                badge.classList.remove('disconnected');
                badge.style.background = '#10b981';
                badgeText.textContent = t('connected');
                badgeText.setAttribute('data-i18n', 'connected');
            } else {
                badge.classList.add('disconnected');
                badge.style.background = '#ef4444';
                badgeText.textContent = t('disconnected');
                badgeText.setAttribute('data-i18n', 'disconnected');
            }
        }

        function updateScanBadge(running) {
            scanRunning = running;
            const badge = document.getElementById('scan-badge');
            const badgeText = badge.querySelector('span[data-i18n]');

            if (running) {
                badge.classList.add('running');
                badgeText.textContent = t('scan_running');
                badgeText.setAttribute('data-i18n', 'scan_running');
            } else {
                badge.classList.remove('running');
                badgeText.textContent = t('scan_stopped');
                badgeText.setAttribute('data-i18n', 'scan_stopped');
            }
        }

        function renderHosts(hosts) {
            const container = document.getElementById('hosts-container');

            // Appliquer le filtre par site
            const filteredHosts = filterHostsBySite(hosts);

            // Mettre √† jour les stats avec les h√¥tes filtr√©s
            updateStats(filteredHosts);

            if (!filteredHosts || filteredHosts.length === 0) {
                container.innerHTML = `
                    <div class="no-hosts">
                        <h2>${t('no_hosts_title')}</h2>
                        <p>${selectedSitesFilter.length > 0 ? (t('no_hosts_for_site') || 'Aucun h√¥te pour ce(s) site(s)') : t('no_hosts_message')}</p>
                    </div>
                `;
                return;
            }

            // Trier les h√¥tes selon le choix actuel
            const sortedHosts = sortHostsData(filteredHosts);

            // R√©cup√©rer ou cr√©er le conteneur grid
            let grid = container.querySelector('.hosts-grid');
            if (!grid) {
                grid = document.createElement('div');
                grid.className = 'hosts-grid';
                container.innerHTML = '';
                container.appendChild(grid);
            }

            // Mettre √† jour ou cr√©er chaque carte
            sortedHosts.forEach((host, index) => {
                const cardId = `host-card-${host.ip.replace(/\./g, '-')}`;
                let card = document.getElementById(cardId);

                if (!card) {
                    // Cr√©er une nouvelle carte
                    card = createHostCardElement(host, cardId);
                    grid.appendChild(card);
                } else {
                    // Mettre √† jour la carte existante sans recr√©er
                    updateHostCard(card, host);
                }

                // R√©ordonner visuellement en changeant l'ordre dans le DOM si n√©cessaire
                if (grid.children[index] !== card) {
                    grid.insertBefore(card, grid.children[index]);
                }
            });

            // Supprimer les cartes des h√¥tes qui n'existent plus
            const currentCards = grid.querySelectorAll('[id^="host-card-"]');
            const currentIPs = sortedHosts.map(h => h.ip.replace(/\./g, '-'));
            currentCards.forEach(card => {
                const cardIP = card.id.replace('host-card-', '');
                if (!currentIPs.includes(cardIP)) {
                    card.remove();
                }
            });
        }

        function createHostCardElement(host, cardId) {
            const card = document.createElement('div');
            card.id = cardId;

            const temperature = host.temp || '-';
            const tempLevel = getTempAlertLevel(temperature);

            // Classe de la carte: offline prioritaire, puis high-temp/warning-temp, puis online
            let cardClass = `host-card ${host.status}`;
            if (host.status === 'online') {
                if (tempLevel === 'critical') {
                    cardClass += ' high-temp';
                } else if (tempLevel === 'warning') {
                    cardClass += ' warning-temp';
                }
            }
            card.className = cardClass;

            // Appliquer la couleur de latence √† la bordure gauche (si disponible)
            if (host.latency_color && host.status === 'online') {
                card.style.borderLeftColor = host.latency_color;
            }

            const displayName = host.nom || t('no_name');
            const statusText = host.status === 'online' ? t('status_online') : t('status_offline');
            const debitIn = host.debit_in || 'N/A';
            const debitOut = host.debit_out || 'N/A';

            let tempClass = 'detail-value';
            let tempDisplay = temperature;
            if (tempLevel === 'critical') {
                tempClass = 'detail-value temp-critical';
                tempDisplay += ' ‚ö†Ô∏è';
            } else if (tempLevel === 'warning') {
                tempClass = 'detail-value temp-warning';
            }

            // Classe de latence pour le badge (uniquement si online)
            const latencyClass = host.status === 'online' ? getLatencyClass(host.latency_color) : '';
            const statusClass = latencyClass ? latencyClass : host.status;

            card.innerHTML = `
                <div class="host-header">
                    <div class="host-name">${escapeHtml(displayName)}</div>
                    <div class="host-status ${statusClass}">${statusText}</div>
                </div>
                <div class="host-ip">${escapeHtml(host.ip)}</div>
                <div class="host-details">
                    <div class="detail-item">
                        <div class="detail-label">${t('mac')}</div>
                        <div class="detail-value">${escapeHtml(host.mac) || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">üå°Ô∏è ${t('temperature')}</div>
                        <div class="${tempClass}">${escapeHtml(tempDisplay)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">üì• ${t('bandwidth_in')}</div>
                        <div class="detail-value">${escapeHtml(debitIn)}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">üì§ ${t('bandwidth_out')}</div>
                        <div class="detail-value">${escapeHtml(debitOut)}</div>
                    </div>
                    <div class="detail-item comment-item">
                        <div class="detail-label">üí¨ ${t('comment')}</div>
                        <textarea class="comment-input" onblur="updateComment('${host.ip}', this.value)" placeholder="${t('comment')}...">${escapeHtml(host.commentaire || '')}</textarea>
                    </div>
                </div>
            `;

            return card;
        }

        function updateHostCard(card, host) {
            const displayName = host.nom || t('no_name');
            const statusText = host.status === 'online' ? t('status_online') : t('status_offline');
            const temperature = host.temp || '-';
            const tempLevel = getTempAlertLevel(temperature);
            const debitIn = host.debit_in || 'N/A';
            const debitOut = host.debit_out || 'N/A';

            // Mettre √† jour la classe de statut (avec high-temp si applicable)
            let cardClass = `host-card ${host.status}`;
            if (host.status === 'online') {
                if (tempLevel === 'critical') {
                    cardClass += ' high-temp';
                } else if (tempLevel === 'warning') {
                    cardClass += ' warning-temp';
                }
            }
            card.className = cardClass;

            // Mettre √† jour la couleur de latence (bordure gauche)
            if (host.latency_color && host.status === 'online') {
                card.style.borderLeftColor = host.latency_color;
            } else if (host.status === 'offline') {
                card.style.borderLeftColor = '#ef4444'; // Rouge pour offline
            }

            // Mettre √† jour le nom
            const nameEl = card.querySelector('.host-name');
            if (nameEl && nameEl.textContent !== displayName) {
                nameEl.textContent = displayName;
            }

            // Mettre √† jour le statut avec la couleur de latence
            const statusEl = card.querySelector('.host-status');
            if (statusEl) {
                const latencyClass = host.status === 'online' ? getLatencyClass(host.latency_color) : '';
                const statusClass = latencyClass ? latencyClass : host.status;
                statusEl.className = `host-status ${statusClass}`;
                if (statusEl.textContent !== statusText) {
                    statusEl.textContent = statusText;
                }
            }

            // Mettre √† jour les valeurs d√©taill√©es
            const details = card.querySelectorAll('.detail-value');
            if (details.length >= 4) {
                // MAC (index 0)
                if (details[0].textContent !== (host.mac || '-')) {
                    details[0].textContent = host.mac || '-';
                }
                // Temp√©rature (index 1) - avec indicateur d'alerte
                let tempDisplay = temperature;
                let tempClass = 'detail-value';

                if (tempLevel === 'critical') {
                    tempDisplay += ' ‚ö†Ô∏è';
                    tempClass = 'detail-value temp-critical';
                } else if (tempLevel === 'warning') {
                    tempClass = 'detail-value temp-warning';
                }

                details[1].className = tempClass;
                if (details[1].textContent !== tempDisplay) {
                    details[1].textContent = tempDisplay;
                }
                // D√©bit IN (index 2)
                if (details[2].textContent !== debitIn) {
                    details[2].textContent = debitIn;
                }
                // D√©bit OUT (index 3)
                if (details[3].textContent !== debitOut) {
                    details[3].textContent = debitOut;
                }

                // Commentaire (index 4) - seulement si pas focalis√©
                const commentInput = card.querySelector('.comment-input');
                if (commentInput && document.activeElement !== commentInput) {
                    if (commentInput.value !== (host.commentaire || '')) {
                        commentInput.value = host.commentaire || '';
                    }
                }
            }
        }

        function updateStats(hosts) {
            const total = hosts.length;
            const online = hosts.filter(h => h.status === 'online').length;
            const offline = total - online;
            const highTempCount = hosts.filter(h => h.status === 'online' && getTempAlertLevel(h.temp) === 'critical').length;
            const warningTempCount = hosts.filter(h => h.status === 'online' && getTempAlertLevel(h.temp) === 'warning').length;

            document.getElementById('total-hosts').textContent = total;
            document.getElementById('online-hosts').textContent = online;
            document.getElementById('offline-hosts').textContent = offline;
            document.getElementById('high-temp-hosts').textContent = highTempCount;
            const warningEl = document.getElementById('warning-temp-hosts');
            if (warningEl) warningEl.textContent = warningTempCount;
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const locale = currentLang === 'fr' ? 'fr-FR' : 'en-US';
            const timeString = now.toLocaleTimeString(locale);
            document.getElementById('last-update-time').textContent = timeString;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateComment(ip, comment) {
            try {
                const response = await fetch('/api/update_comment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ip, comment }),
                });
                const data = await response.json();
                if (!data.success) {
                    console.error('Erreur lors de la mise √† jour du commentaire:', data.error);
                }
            } catch (error) {
                console.error('Erreur r√©seau updateComment:', error);
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/logout', { method: 'POST' });
                if (response.ok) {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Erreur d√©connexion:', error);
                window.location.href = '/login';
            }
        }

        // Demander une mise √† jour toutes les 10 secondes
        setInterval(() => {
            socket.emit('request_update');
        }, 10000);

        // Charger la langue et demander les donn√©es au chargement
        loadLanguage();
        socket.emit('request_update');
    </script>
</body>

</html>