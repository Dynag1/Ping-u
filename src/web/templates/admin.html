<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Ping √º</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            font-size: 22px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .checkbox-group label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
        }

        .hosts-table {
            width: 100%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .hosts-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .hosts-table th {
            background: #f3f4f6;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .hosts-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .hosts-table tr:hover {
            background: #f9fafb;
        }

        .host-status {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .host-status.online {
            background: #d1fae5;
            color: #065f46;
        }

        .host-status.offline {
            background: #fee2e2;
            color: #991b1b;
        }

        .host-actions {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 6px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-indicator.running {
            background: #d1fae5;
            color: #065f46;
        }

        .status-indicator.stopped {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.running {
            background: #10b981;
        }

        .status-dot.stopped {
            background: #ef4444;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #6b7280;
            font-size: 14px;
        }

        .stat-card.total .value { color: #3b82f6; }
        .stat-card.online .value { color: #10b981; }
        .stat-card.offline .value { color: #ef4444; }
        .stat-card.monitoring .value { color: #8b5cf6; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .accordion {
            margin-bottom: 10px;
        }

        .accordion-header {
            background: #f3f4f6;
            padding: 15px 20px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
            font-weight: 600;
            color: #374151;
        }

        .accordion-header:hover {
            background: #e5e7eb;
        }

        .accordion-header.active {
            background: #667eea;
            color: white;
            border-radius: 8px 8px 0 0;
        }

        .accordion-content {
            display: none;
            padding: 20px;
            background: #f9fafb;
            border-radius: 0 0 8px 8px;
            margin-bottom: 10px;
        }

        .accordion-content.active {
            display: block;
        }

        .accordion-icon {
            transition: transform 0.3s;
        }

        .accordion-icon.active {
            transform: rotate(180deg);
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>‚öôÔ∏è Administration - Ping √º</h1>
            <div class="header-actions">
                <div class="status-indicator" id="monitoring-status">
                    <span class="status-dot stopped"></span>
                    <span>Arr√™t√©</span>
                </div>
                <button id="btn-change-password" class="btn btn-info">üîë Changer identifiants</button>
                <a href="/" class="btn btn-secondary">üìä Vue Monitoring</a>
                <button id="btn-logout" class="btn btn-danger">üö™ D√©connexion</button>
            </div>
        </div>

        <!-- Modal Changement de mot de passe -->
        <div id="modal-change-password" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
                <h2 style="margin-bottom: 20px; color: #333;">Changer les identifiants</h2>
                <form id="form-change-password">
                    <div class="form-group">
                        <label>Mot de passe actuel</label>
                        <input type="password" id="old-password" required>
                    </div>
                    <div class="form-group">
                        <label>Nouveau nom d'utilisateur</label>
                        <input type="text" id="new-username" required>
                    </div>
                    <div class="form-group">
                        <label>Nouveau mot de passe</label>
                        <input type="password" id="new-password" required>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">üíæ Enregistrer</button>
                        <button type="button" id="btn-cancel-change" class="btn btn-secondary" style="flex: 1;">‚ùå Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="value" id="stat-total">0</div>
                <div class="label">Total H√¥tes</div>
            </div>
            <div class="stat-card online">
                <div class="value" id="stat-online">0</div>
                <div class="label">En ligne</div>
            </div>
            <div class="stat-card offline">
                <div class="value" id="stat-offline">0</div>
                <div class="label">Hors ligne</div>
            </div>
            <div class="stat-card monitoring">
                <div class="value" id="stat-delai">0</div>
                <div class="label">D√©lai (sec)</div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Ajout d'IP -->
            <div class="card">
                <h2>‚ûï Ajout d'H√¥tes</h2>
                <form id="form-add-hosts">
                    <div class="form-group">
                        <label for="input-ip">Adresse IP de base</label>
                        <input type="text" id="input-ip" placeholder="192.168.1.1" required>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="input-hosts">Nombre d'h√¥tes</label>
                            <input type="number" id="input-hosts" value="1" min="1" max="255">
                        </div>
                        <div class="form-group">
                            <label for="input-port">Port</label>
                            <input type="text" id="input-port" value="80">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="select-scan-type">Type de scan</label>
                        <select id="select-scan-type">
                            <option value="alive">Alive (actifs uniquement)</option>
                            <option value="all">Tous les h√¥tes</option>
                            <option value="site">Site sp√©cifique</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        üîç Scanner les h√¥tes
                    </button>
                </form>
            </div>

            <!-- Contr√¥le du Monitoring -->
            <div class="card">
                <h2>üéÆ Contr√¥le du Monitoring</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="input-delai">D√©lai entre pings (sec)</label>
                        <input type="number" id="input-delai" value="10" min="1" max="3600">
                    </div>
                    <div class="form-group">
                        <label for="input-nb-hs">Nombre de HS avant alerte</label>
                        <input type="number" id="input-nb-hs" value="3" min="1" max="10">
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="btn-start-monitoring" class="btn btn-primary" style="flex: 1;">
                        ‚ñ∂Ô∏è D√©marrer
                    </button>
                    <button id="btn-stop-monitoring" class="btn btn-danger" style="flex: 1;">
                        ‚èπÔ∏è Arr√™ter
                    </button>
                </div>
            </div>

            <!-- Alertes -->
            <div class="card">
                <h2>üîî Configuration des Alertes</h2>
                <div class="checkbox-group">
                    <input type="checkbox" id="check-popup">
                    <label for="check-popup">üí¨ Popup (notification visuelle)</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="check-mail">
                    <label for="check-mail">üìß Email d'alerte</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="check-telegram">
                    <label for="check-telegram">üì± Telegram</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="check-mail-recap">
                    <label for="check-mail-recap">üìä Email r√©capitulatif</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="check-db-externe">
                    <label for="check-db-externe">üíæ Base de donn√©es externe</label>
                </div>
                <button id="btn-save-alerts" class="btn btn-info" style="width: 100%; margin-top: 15px;">
                    üíæ Sauvegarder les alertes
                </button>
            </div>

            <!-- Actions rapides -->
            <div class="card">
                <h2>‚ö° Actions Rapides</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button id="btn-clear-all" class="btn btn-danger">
                        üóëÔ∏è Tout effacer
                    </button>
                    <button id="btn-export-csv" class="btn btn-info">
                        üì• Exporter CSV
                    </button>
                    <button id="btn-import-csv" class="btn btn-info">
                        üì§ Importer CSV
                    </button>
                    <button id="btn-save-settings" class="btn btn-primary">
                        üíæ Sauvegarder
                    </button>
                </div>
                <input type="file" id="file-import-csv" accept=".csv" style="display: none;">
            </div>
        </div>

        <!-- Param√®tres Avanc√©s -->
        <div class="card full-width">
            <h2>‚öôÔ∏è Param√®tres Avanc√©s</h2>
            
            <!-- Configuration SMTP -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('smtp')">
                    <span>üìß Configuration Email (SMTP)</span>
                    <span class="accordion-icon" id="icon-smtp">‚ñº</span>
                </div>
                <div class="accordion-content" id="content-smtp">
                    <form id="form-smtp">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="smtp-server">Serveur SMTP</label>
                                <input type="text" id="smtp-server" placeholder="smtp.gmail.com">
                            </div>
                            <div class="form-group">
                                <label for="smtp-port">Port</label>
                                <input type="number" id="smtp-port" placeholder="587" value="587">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="smtp-email">Email exp√©diteur</label>
                            <input type="email" id="smtp-email" placeholder="votre-email@gmail.com">
                        </div>
                        <div class="form-group">
                            <label for="smtp-password">Mot de passe</label>
                            <input type="password" id="smtp-password" placeholder="Mot de passe ou app password">
                        </div>
                        <div class="form-group">
                            <label for="smtp-recipients">Destinataires (s√©par√©s par des virgules)</label>
                            <input type="text" id="smtp-recipients" placeholder="email1@exemple.com, email2@exemple.com">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ Sauvegarder
                            </button>
                            <button type="button" class="btn btn-info" onclick="testSMTP()" style="flex: 1;">
                                ‚úâÔ∏è Tester
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Configuration Telegram -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('telegram')">
                    <span>üì± Configuration Telegram</span>
                    <span class="accordion-icon" id="icon-telegram">‚ñº</span>
                </div>
                <div class="accordion-content" id="content-telegram">
                    <form id="form-telegram">
                        <div class="form-group">
                            <label for="telegram-token">Token du Bot</label>
                            <input type="text" id="telegram-token" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
                        </div>
                        <div class="form-group">
                            <label for="telegram-chatid">Chat ID</label>
                            <input type="text" id="telegram-chatid" placeholder="123456789">
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary" style="flex: 1;">
                                üíæ Sauvegarder
                            </button>
                            <button type="button" class="btn btn-info" onclick="testTelegram()" style="flex: 1;">
                                üì≤ Tester
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Param√®tres G√©n√©raux -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('general')">
                    <span>üåê Param√®tres G√©n√©raux</span>
                    <span class="accordion-icon" id="icon-general">‚ñº</span>
                </div>
                <div class="accordion-content" id="content-general">
                    <form id="form-general">
                        <div class="form-group">
                            <label for="general-site">Site Web</label>
                            <input type="url" id="general-site" placeholder="https://example.com">
                        </div>
                        <div class="form-group">
                            <label for="general-theme">Th√®me</label>
                            <select id="general-theme">
                                <option value="nord">Nord</option>
                                <option value="dark">Dark</option>
                                <option value="light">Light</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            üíæ Sauvegarder
                        </button>
                    </form>
                </div>
            </div>

            <!-- Licence -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('license')">
                    <span>üîë Gestion de Licence</span>
                    <span class="accordion-icon" id="icon-license">‚ñº</span>
                </div>
                <div class="accordion-content" id="content-license">
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 24px;" id="license-icon">‚ùå</span>
                            <div>
                                <div style="font-weight: 600; color: #374151;" id="license-status">Pas de licence active</div>
                                <div style="font-size: 13px; color: #6b7280;" id="license-days"></div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; border-top: 1px solid #e5e7eb; padding-top: 10px;">
                            <div style="font-size: 12px; color: #6b7280; margin-bottom: 5px;">Code d'activation (Hardware ID) √† envoyer :</div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="activation-code" readonly style="background: #e5e7eb; color: #374151; font-family: monospace; font-size: 14px;" onclick="this.select()">
                                <button class="btn btn-secondary btn-small" onclick="navigator.clipboard.writeText(document.getElementById('activation-code').value); showNotification('Copi√© !', 'success')">üìã</button>
                            </div>
                        </div>
                    </div>
                    <form id="form-license">
                        <div class="form-group">
                            <label for="license-key">Cl√© de licence</label>
                            <input type="text" id="license-key" placeholder="Entrez votre cl√© de licence">
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            üîì Activer la licence
                        </button>
                    </form>
                </div>
            </div>

            <!-- Informations Syst√®me -->
            <div class="accordion">
                <div class="accordion-header" onclick="toggleAccordion('system')">
                    <span>‚ÑπÔ∏è Informations Syst√®me</span>
                    <span class="accordion-icon" id="icon-system">‚ñº</span>
                </div>
                <div class="accordion-content" id="content-system">
                    <div style="background: #f3f4f6; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <strong>Version:</strong> <span id="system-version">-</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Mode:</strong> <span>Serveur Web</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>Port:</strong> <span>9090</span>
                        </div>
                        <div>
                            <strong>Utilisateur connect√©:</strong> <span id="system-user">admin</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des h√¥tes -->
        <div class="card full-width">
            <h2>üìã Liste des H√¥tes Monitor√©s</h2>
            <div class="hosts-table">
                <table>
                    <thead>
                        <tr>
                            <th>IP</th>
                            <th>Nom</th>
                            <th>MAC</th>
                            <th>Port</th>
                            <th>Latence</th>
                            <th>Temp√©rature</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="hosts-table-body">
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">
                                Aucun h√¥te configur√©. Ajoutez des h√¥tes pour commencer le monitoring.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io({
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 10
        });

        let hostsData = [];
        let monitoringRunning = false;

        // ==================== Socket Events ====================
        socket.on('connect', function() {
            console.log('‚úÖ Connect√© au serveur');
            loadSettings();
            socket.emit('request_update');
        });

        socket.on('disconnect', function() {
            console.log('‚ùå D√©connect√© du serveur');
        });

        socket.on('hosts_update', function(hosts) {
            if (!Array.isArray(hosts)) {
                hosts = [];
            }
            hostsData = hosts;
            updateHostsTable(hosts);
            updateStats(hosts);
        });

        socket.on('monitoring_status', function(data) {
            monitoringRunning = data.running;
            updateMonitoringStatus(data.running);
        });

        socket.on('notification', function(data) {
            showNotification(data.message, data.type || 'info');
        });

        // ==================== Update Functions ====================
        function updateStats(hosts) {
            const total = hosts.length;
            const online = hosts.filter(h => h.status === 'online').length;
            const offline = total - online;

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-online').textContent = online;
            document.getElementById('stat-offline').textContent = offline;
        }

        function updateMonitoringStatus(running) {
            const statusEl = document.getElementById('monitoring-status');
            const dot = statusEl.querySelector('.status-dot');
            const text = statusEl.querySelector('span:last-child');

            if (running) {
                statusEl.className = 'status-indicator running';
                dot.className = 'status-dot running';
                text.textContent = 'En cours';
            } else {
                statusEl.className = 'status-indicator stopped';
                dot.className = 'status-dot stopped';
                text.textContent = 'Arr√™t√©';
            }
        }

        function updateHostsTable(hosts) {
            const tbody = document.getElementById('hosts-table-body');
            
            if (hosts.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #9ca3af;">
                            Aucun h√¥te configur√©. Ajoutez des h√¥tes pour commencer le monitoring.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = hosts.map(host => `
                <tr>
                    <td><strong>${escapeHtml(host.ip)}</strong></td>
                    <td>${escapeHtml(host.nom) || '-'}</td>
                    <td>${escapeHtml(host.mac) || '-'}</td>
                    <td>${escapeHtml(host.port) || '-'}</td>
                    <td>${escapeHtml(host.latence) || '-'}</td>
                    <td>${escapeHtml(host.temp) || '-'}</td>
                    <td>
                        <span class="host-status ${host.status}">
                            ${host.status === 'online' ? 'En ligne' : 'Hors ligne'}
                        </span>
                    </td>
                    <td class="host-actions">
                        <button class="btn btn-danger btn-small" onclick="deleteHost('${host.ip}')">
                            üóëÔ∏è
                        </button>
                        <button class="btn btn-secondary btn-small" onclick="excludeHost('${host.ip}')">
                            üö´
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // ==================== API Functions ====================
        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(endpoint, options);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erreur API');
                }

                return result;
            } catch (error) {
                console.error('Erreur API:', error);
                showNotification('Erreur: ' + error.message, 'error');
                throw error;
            }
        }

        // ==================== Event Handlers ====================
        document.getElementById('form-add-hosts').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const data = {
                ip: document.getElementById('input-ip').value,
                hosts: parseInt(document.getElementById('input-hosts').value),
                port: document.getElementById('input-port').value,
                scan_type: document.getElementById('select-scan-type').value
            };

            try {
                const result = await apiCall('/api/add_hosts', 'POST', data);
                showNotification(result.message || 'Scan d√©marr√©', 'success');
                setTimeout(() => socket.emit('request_update'), 2000);
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        document.getElementById('btn-start-monitoring').addEventListener('click', async function() {
            const delai = parseInt(document.getElementById('input-delai').value);
            const nbHs = parseInt(document.getElementById('input-nb-hs').value);

            try {
                const result = await apiCall('/api/start_monitoring', 'POST', { delai, nb_hs: nbHs });
                showNotification('Monitoring d√©marr√©', 'success');
                monitoringRunning = true;
                updateMonitoringStatus(true);
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        document.getElementById('btn-stop-monitoring').addEventListener('click', async function() {
            try {
                const result = await apiCall('/api/stop_monitoring', 'POST');
                showNotification('Monitoring arr√™t√©', 'info');
                monitoringRunning = false;
                updateMonitoringStatus(false);
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        document.getElementById('btn-save-alerts').addEventListener('click', async function() {
            const alerts = {
                popup: document.getElementById('check-popup').checked,
                mail: document.getElementById('check-mail').checked,
                telegram: document.getElementById('check-telegram').checked,
                mail_recap: document.getElementById('check-mail-recap').checked,
                db_externe: document.getElementById('check-db-externe').checked
            };

            try {
                const result = await apiCall('/api/save_alerts', 'POST', alerts);
                showNotification('Alertes sauvegard√©es', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        document.getElementById('btn-clear-all').addEventListener('click', async function() {
            if (!confirm('Voulez-vous vraiment effacer tous les h√¥tes ?')) {
                return;
            }

            try {
                const result = await apiCall('/api/clear_all', 'POST');
                showNotification('Tous les h√¥tes ont √©t√© supprim√©s', 'info');
                socket.emit('request_update');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        document.getElementById('btn-export-csv').addEventListener('click', async function() {
            try {
                window.location.href = '/api/export_csv';
                showNotification('Export CSV d√©marr√©', 'success');
            } catch (error) {
                showNotification('Erreur lors de l\'export', 'error');
            }
        });

        document.getElementById('btn-import-csv').addEventListener('click', function() {
            document.getElementById('file-import-csv').click();
        });

        document.getElementById('file-import-csv').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/import_csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                
                if (response.ok) {
                    showNotification(result.message || 'Import r√©ussi', 'success');
                    socket.emit('request_update');
                } else {
                    showNotification(result.error || 'Erreur lors de l\'import', 'error');
                }
            } catch (error) {
                showNotification('Erreur lors de l\'import', 'error');
            }

            e.target.value = '';
        });

        document.getElementById('btn-save-settings').addEventListener('click', async function() {
            try {
                const result = await apiCall('/api/save_settings', 'POST');
                showNotification('Param√®tres sauvegard√©s', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        // ==================== Host Actions ====================
        async function deleteHost(ip) {
            if (!confirm(`Voulez-vous vraiment supprimer l'h√¥te ${ip} ?`)) {
                return;
            }

            try {
                const result = await apiCall('/api/delete_host', 'POST', { ip });
                showNotification(`H√¥te ${ip} supprim√©`, 'info');
                socket.emit('request_update');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        }

        async function excludeHost(ip) {
            try {
                const result = await apiCall('/api/exclude_host', 'POST', { ip });
                showNotification(`H√¥te ${ip} exclu`, 'info');
                socket.emit('request_update');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        }

        // ==================== Settings ====================
        async function loadSettings() {
            try {
                const result = await apiCall('/api/get_settings');
                
                // Monitoring
                if (result.delai) {
                    document.getElementById('input-delai').value = result.delai;
                    document.getElementById('stat-delai').textContent = result.delai;
                }
                if (result.nb_hs) {
                    document.getElementById('input-nb-hs').value = result.nb_hs;
                }
                
                // Alertes
                if (result.alerts) {
                    document.getElementById('check-popup').checked = result.alerts.popup || false;
                    document.getElementById('check-mail').checked = result.alerts.mail || false;
                    document.getElementById('check-telegram').checked = result.alerts.telegram || false;
                    document.getElementById('check-mail-recap').checked = result.alerts.mail_recap || false;
                    document.getElementById('check-db-externe').checked = result.alerts.db_externe || false;
                }
                
                // Statut monitoring
                if (typeof result.monitoring_running !== 'undefined') {
                    monitoringRunning = result.monitoring_running;
                    updateMonitoringStatus(result.monitoring_running);
                }
                
                // SMTP
                if (result.smtp) {
                    document.getElementById('smtp-server').value = result.smtp.server || '';
                    document.getElementById('smtp-port').value = result.smtp.port || '587';
                    document.getElementById('smtp-email').value = result.smtp.email || '';
                    document.getElementById('smtp-recipients').value = result.smtp.recipients || '';
                }
                
                // Param√®tres g√©n√©raux
                if (result.general) {
                    document.getElementById('general-site').value = result.general.site || '';
                    document.getElementById('general-theme').value = result.general.theme || 'nord';
                }
                
                // Version syst√®me
                if (result.version) {
                    document.getElementById('system-version').textContent = result.version;
                }
            } catch (error) {
                console.error('Erreur chargement param√®tres:', error);
            }
        }

        // ==================== Utility Functions ====================
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==================== Auto-refresh ====================
        setInterval(() => {
            socket.emit('request_update');
        }, 10000);

        // ==================== Accordions ====================
        function toggleAccordion(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);
            const header = icon.parentElement;
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.classList.remove('active');
                header.classList.remove('active');
            } else {
                content.classList.add('active');
                icon.classList.add('active');
                header.classList.add('active');
            }
        }

        // ==================== Configuration SMTP ====================
        document.getElementById('form-smtp').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                server: document.getElementById('smtp-server').value,
                port: document.getElementById('smtp-port').value,
                email: document.getElementById('smtp-email').value,
                password: document.getElementById('smtp-password').value,
                recipients: document.getElementById('smtp-recipients').value
            };

            try {
                const result = await apiCall('/api/save_smtp', 'POST', data);
                showNotification('Configuration SMTP sauvegard√©e', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        async function testSMTP() {
            try {
                const result = await apiCall('/api/test_smtp', 'POST');
                showNotification('Email de test envoy√©', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        }

        // ==================== Configuration Telegram ====================
        document.getElementById('form-telegram').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                token: document.getElementById('telegram-token').value,
                chatid: document.getElementById('telegram-chatid').value
            };

            try {
                // TODO: Ajouter la route API pour Telegram
                showNotification('Configuration Telegram sauvegard√©e', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        async function testTelegram() {
            try {
                // TODO: Ajouter la route API pour test Telegram
                showNotification('Message de test envoy√© sur Telegram', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        }

        // ==================== Param√®tres G√©n√©raux ====================
        document.getElementById('form-general').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                site: document.getElementById('general-site').value,
                license: '', // G√©r√© s√©par√©ment dans la section licence
                theme: document.getElementById('general-theme').value
            };

            try {
                const result = await apiCall('/api/save_general', 'POST', data);
                showNotification('Param√®tres g√©n√©raux sauvegard√©s', 'success');
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        // ==================== Licence ====================
        document.getElementById('form-license').addEventListener('submit', async function(e) {
            e.preventDefault();

            const licenseKey = document.getElementById('license-key').value;
            
            const data = {
                site: document.getElementById('general-site').value,
                license: licenseKey,
                theme: document.getElementById('general-theme').value
            };

            try {
                const result = await apiCall('/api/save_general', 'POST', data);
                showNotification('Licence enregistr√©e', 'success');
                // Recharger les infos de licence
                loadLicenseInfo();
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        async function loadLicenseInfo() {
            try {
                const result = await apiCall('/api/get_license_info');
                
                const icon = document.getElementById('license-icon');
                const status = document.getElementById('license-status');
                const days = document.getElementById('license-days');
                const codeInput = document.getElementById('activation-code');
                
                if (result.activation_code) {
                    codeInput.value = result.activation_code;
                }
                
                const isLicenseActive = result.active;
                
                // Gestion des champs d'alerte (seul Popup est gratuit)
                const paidAlerts = ['check-mail', 'check-telegram', 'check-mail-recap', 'check-db-externe'];
                paidAlerts.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.disabled = !isLicenseActive;
                        if (!isLicenseActive) {
                            el.checked = false;
                            el.parentElement.title = "N√©cessite une licence active";
                            el.parentElement.style.opacity = "0.6";
                        } else {
                            el.parentElement.title = "";
                            el.parentElement.style.opacity = "1";
                        }
                    }
                });

                if (isLicenseActive) {
                    icon.textContent = '‚úÖ';
                    status.textContent = 'Licence active';
                    days.textContent = `${result.days_remaining} jours restants`;
                    status.style.color = '#10b981';
                } else {
                    icon.textContent = '‚ùå';
                    status.textContent = 'Pas de licence active';
                    days.textContent = 'Certaines fonctionnalit√©s sont limit√©es (Alertes)';
                    status.style.color = '#ef4444';
                }
            } catch (error) {
                console.error('Erreur chargement info licence:', error);
            }
        }

        // ==================== Authentification ====================
        document.getElementById('btn-logout').addEventListener('click', async function() {
            if (!confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                return;
            }

            try {
                const result = await apiCall('/api/logout', 'POST');
                window.location.href = '/login';
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        document.getElementById('btn-change-password').addEventListener('click', function() {
            const modal = document.getElementById('modal-change-password');
            modal.style.display = 'flex';
        });

        document.getElementById('btn-cancel-change').addEventListener('click', function() {
            const modal = document.getElementById('modal-change-password');
            modal.style.display = 'none';
            document.getElementById('form-change-password').reset();
        });

        document.getElementById('form-change-password').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
                old_password: document.getElementById('old-password').value,
                new_username: document.getElementById('new-username').value,
                new_password: document.getElementById('new-password').value
            };

            try {
                const result = await apiCall('/api/change_credentials', 'POST', data);
                showNotification('Identifiants modifi√©s ! Reconnexion n√©cessaire.', 'success');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 2000);
            } catch (error) {
                // Erreur d√©j√† affich√©e
            }
        });

        // ==================== User Info ====================
        async function loadUserInfo() {
            try {
                const result = await apiCall('/api/get_user_info');
                if (result.username) {
                    document.getElementById('system-user').textContent = result.username;
                }
            } catch (error) {
                console.error('Erreur chargement info utilisateur:', error);
            }
        }

        // Initial load
        loadSettings();
        loadLicenseInfo();
        loadUserInfo();
    </script>
</body>
</html>

